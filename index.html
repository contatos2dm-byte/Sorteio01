<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sorteio Tambor Xamânico | Apoio CTTC</title>
<style>
    /* ... (os mesmos estilos de antes) ... */
    :root {
        --verde-floresta: #0B3D2E; --verde-vivo: #1F7A4C; --verde-claro: #4CAF50;
        --amarelo-sol: #F4C430; --bege-terra: #F5F1E6; --branco: #FFFFFF;
        --cinza-ocupado: #888; --vermelho-erro: #d9534f;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { background: var(--bege-terra); color: var(--verde-floresta); text-align: center; }
    .hero { background: linear-gradient(135deg, var(--verde-floresta), var(--verde-vivo)); color: var(--branco); padding: 60px 20px; }
    .numbers { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 10px; justify-content: center; margin: 30px 20px; max-width: 700px; margin-left: auto; margin-right: auto; }
    .number { background: var(--verde-claro); color: var(--branco); padding: 15px 0; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; user-select: none; }
    .number:hover { transform: scale(1.1); }
    .number.pago { background: var(--cinza-ocupado); cursor: not-allowed; color: #ccc; }
    .number.pago:hover { transform: none; }
    .number.selecionado { background: var(--amarelo-sol); color: var(--verde-floresta); border: 2px solid var(--verde-floresta); }
    .btn { background: var(--amarelo-sol); color: var(--verde-floresta); padding: 15px 30px; border-radius: 30px; text-decoration: none; font-weight: bold; display: inline-block; margin: 20px 0; transition: 0.3s; cursor: pointer; border: none; }
    .btn:hover { background: var(--verde-vivo); color: var(--branco); }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    /* ... (resto dos estilos, incluindo o modal) ... */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; text-align: left; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    #modal-message { text-align: center; margin-top: 15px; font-weight: bold; }
    .success { color: var(--verde-vivo); }
    .error { color: var(--vermelho-erro); }
</style>
</head>
<body>
    <!-- ... (Hero, Imagem, etc. - sem alterações) ... -->
    <section>
      <h2>Escolha seus números da sorte!</h2>
      <div class="numbers" id="rifa-numeros"></div>
      <button id="btn-confirmar-selecao" class="btn" disabled>Apoiar e Confirmar Números</button>
    </section>
    <!-- ... (Contribuições, Links, Footer - sem alterações) ... -->

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Confirmar os Números: <span id="numeros-selecionados-lista" style="color: var(--verde-vivo);"></span></h2>
        <p>Total: <strong id="total-pagar"></strong></p>
        <hr style="margin: 15px 0;">
        <form id="confirmForm">
          <label for="nome">Nome:</label>
          <input type="text" id="nome" name="nome" required>
          <label for="telefone">Seu WhatsApp (com DDD):</label>
          <input type="tel" id="telefone" name="telefone" placeholder="Ex: 11987654321" required>
          <label for="transacao">ID da Transação (Pix ou Hash Cripto):</label>
          <input type="text" id="transacao" name="transacao" required>
          <button type="submit" class="btn">Confirmar Compra</button>
          <p id="modal-message"></p>
        </form>
      </div>
    </div>

<script>
    // !!! IMPORTANTE: SUBSTITUA PELA URL DA SUA API HOSPEDADA !!!
    const API_URL = "https://sua-api-aqui.onrender.com"; // Exemplo para Render.com

    const numbersContainer = document.getElementById("rifa-numeros" );
    const btnConfirmar = document.getElementById("btn-confirmar-selecao");
    const modal = document.getElementById("confirmModal");
    const closeModal = document.querySelector(".close");
    const form = document.getElementById("confirmForm");
    const numerosSelecionadosLista = document.getElementById("numeros-selecionados-lista");
    const totalPagar = document.getElementById("total-pagar");
    const modalMessage = document.getElementById("modal-message");

    let numerosSelecionados = [];

    // Função para lidar com a seleção de números
    function toggleNumero(num, numDiv) {
        if (numDiv.classList.contains('pago')) return;

        const index = numerosSelecionados.indexOf(num);
        if (index > -1) {
            numerosSelecionados.splice(index, 1); // Remove se já selecionado
            numDiv.classList.remove('selecionado');
        } else {
            numerosSelecionados.push(num); // Adiciona se não selecionado
            numDiv.classList.add('selecionado');
        }
        
        // Habilita/desabilita o botão de confirmar
        btnConfirmar.disabled = numerosSelecionados.length === 0;
    }

    async function carregarNumeros() {
        try {
            const response = await fetch(`${API_URL}/status-numeros`);
            if (!response.ok) throw new Error('Não foi possível carregar os dados da rifa.');
            const numeros = await response.json();
            
            numbersContainer.innerHTML = '';
            for (let i = 1; i <= 50; i++) {
                const numData = numeros[i];
                const numDiv = document.createElement('div');
                numDiv.classList.add('number');
                numDiv.textContent = i.toString().padStart(2, '0');
                
                if (numData && numData.status === 'pago') {
                    numDiv.classList.add('pago');
                    numDiv.title = `Comprado por ${numData.dono}`;
                } else {
                    numDiv.addEventListener('click', () => toggleNumero(i, numDiv));
                }
                numbersContainer.appendChild(numDiv);
            }
        } catch (error) {
            numbersContainer.innerHTML = `<p class="error">${error.message} Verifique se a API está online.</p>`;
        }
    }

    btnConfirmar.addEventListener('click', () => {
        if (numerosSelecionados.length > 0) {
            numerosSelecionadosLista.textContent = numerosSelecionados.join(', ');
            totalPagar.textContent = `R$ ${numerosSelecionados.length * 10},00`;
            form.reset();
            modalMessage.textContent = '';
            modal.style.display = "block";
        }
    });

    closeModal.onclick = () => modal.style.display = "none";
    window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        modalMessage.textContent = 'Enviando...';
        modalMessage.className = '';

        const dados = {
            nome: document.getElementById("nome").value,
            telefone: document.getElementById("telefone").value,
            numeros: numerosSelecionados, // Envia o array de números
            transacao: document.getElementById("transacao").value,
        };

        try {
            const response = await fetch(`${API_URL}/confirmar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Ocorreu um erro.');

            modalMessage.textContent = "Sucesso! Seus números foram confirmados.";
            modalMessage.classList.add('success');
            
            numerosSelecionados = []; // Limpa a seleção
            btnConfirmar.disabled = true;

            setTimeout(() => {
                modal.style.display = "none";
                carregarNumeros(); // Recarrega os números para mostrar o novo status
            }, 2000);

        } catch (error) {
            modalMessage.textContent = `Erro: ${error.message}`;
            modalMessage.classList.add('error');
        }
    });

    document.addEventListener('DOMContentLoaded', carregarNumeros);
</script>
</body>
</html>
